var data = {
  "Lithuania": { n: 31.9, r: 1 },
  "Russia": { n: 31, r: 2 },
  "Guyana": { n: 29.2, r: 3 },
  "South Korea": { n: 26.9, r: 4 },
  "Belarus": { n: 26.2, r: 5 },
  "Suriname": { n: 22.8, r: 6 },
  "Kazakhstan": { n: 22.5, r: 7 },
  "Ukraine": { n: 22.4, r: 8 },
  "Latvia": { n: 21.2, r: 10 },
  "Lesotho": { n: 21.2, r: 9 },
  "Belgium": { n: 20.7, r: 11 },
  "Hungary": { n: 19.1, r: 12 },
  "Slovenia": { n: 18.6, r: 13 },
  "Japan": { n: 18.5, r: 14 },
  "Uruguay": { n: 18.4, r: 15 },
  "Estonia": { n: 17.8, r: 16 },
  "France": { n: 17.7, r: 17 },
  "Switzerland": { n: 17.2, r: 18 },
  "Croatia": { n: 16.5, r: 19 },
  "Equatorial Guinea": { n: 16.4, r: 20 },
  "India": { n: 16.3, r: 21 },
  "Poland": { n: 16.2, r: 22 },
  "Moldova": { n: 15.9, r: 24 },
  "Finland": { n: 15.9, r: 23 },
  "Serbia": { n: 15.6, r: 26 },
  "Austria": { n: 15.6, r: 25 },
  "United States": { n: 15.3, r: 27 },
  "Sweden": { n: 14.8, r: 28 },
  "Sri Lanka": { n: 14.6, r: 29 },
  "Thailand": { n: 14.4, r: 31 },
  "Kiribati": { n: 14.4, r: 30 },
  "Portugal": { n: 14, r: 33 },
  "Iceland": { n: 14, r: 32 },
  "Cuba": { n: 13.9, r: 34 },
  "El Salvador": { n: 13.7, r: 35 },
  "Trinidad And Tobago": { n: 13.6, r: 37 },
  "Germany": { n: 13.6, r: 36 },
  "Luxembourg": { n: 13.5, r: 38 },
  "Australia": { n: 13.2, r: 39 },
  "Mongolia": { n: 13, r: 40 },
  "Slovakia": { n: 12.8, r: 42 },
  "Denmark": { n: 12.8, r: 41 },
  "Netherlands": { n: 12.6, r: 43 },
  "Canada": { n: 12.5, r: 44 },
  "Norway": { n: 12.2, r: 48 },
  "Nicaragua": { n: 12.2, r: 47 },
  "Cameroon": { n: 12.2, r: 46 },
  "Bolivia": { n: 12.2, r: 45 },
  "New Zealand": { n: 12.1, r: 49 },
  "Haiti": { n: 11.7, r: 50 },
  "South Africa": { n: 11.6, r: 51 },
  "Ireland": { n: 11.5, r: 53 },
  "Bulgaria": { n: 11.5, r: 52 },
  "Bhutan": { n: 11.4, r: 54 },
  "Cape Verde": { n: 11.3, r: 55 },
  "Zimbabwe": { n: 10.7, r: 56 },
  "Chile": { n: 10.6, r: 57 },
  "Romania": { n: 10.4, r: 58 },
  "Montenegro": { n: 10.3, r: 59 },
  "Uganda": { n: 9.9, r: 63 },
  "Singapore": { n: 9.9, r: 62 },
  "Dominican Republic": { n: 9.9, r: 61 },
  "Benin": { n: 9.9, r: 60 },
  "Sierra Leone": { n: 9.7, r: 65 },
  "China": { n: 9.7, r: 64 },
  "Togo": { n: 9.6, r: 66 },
  "Paraguay": { n: 9.5, r: 68 },
  "Nigeria": { n: 9.5, r: 67 },
  "Seychelles": { n: 9.3, r: 70 },
  "Botswana": { n: 9.3, r: 69 },
  "Argentina": { n: 9.2, r: 71 },
  "Burundi": { n: 9.1, r: 72 },
  "Nepal": { n: 8.8, r: 75 },
  "Chad": { n: 8.8, r: 74 },
  "Bosnia And Herzegovina": { n: 8.8, r: 73 },
  "Spain": { n: 8.7, r: 77 },
  "Namibia": { n: 8.7, r: 76 },
  "Laos": { n: 8.6, r: 78 },
  "Yemen": { n: 8.5, r: 79 },
  "Kyrgyzstan": { n: 8.3, r: 80 },
  "Italy": { n: 8.2, r: 82 },
  "Georgia": { n: 8.2, r: 81 },
  "Sudan": { n: 8.1, r: 83 },
  "Eritrea": { n: 7.9, r: 85 },
  "Costa Rica": { n: 7.9, r: 84 },
  "Saint Lucia": { n: 7.8, r: 88 },
  "Mauritius": { n: 7.8, r: 87 },
  "Myanmar": { n: 7.8, r: 86 },
  "Burkina Faso": { n: 7.7, r: 90 },
  "Central African Republic": { n: 7.7, r: 89 },
  "Malta": { n: 7.5, r: 91 },
  "Uzbekistan": { n: 7.4, r: 92 },
  "Turkey": { n: 7.3, r: 94 },
  "Vietnam": { n: 7.3, r: 93 },
  "Ethiopia": { n: 7.2, r: 96 },
  "Colombia": { n: 7.2, r: 95 },
  "Gabon": { n: 7.1, r: 98 },
  "Ecuador": { n: 7.1, r: 97 },
  "Liberia": { n: 6.8, r: 100 },
  "Comoros": { n: 6.8, r: 99 },
  "Turkmenistan": { n: 6.7, r: 103 },
  "Rwanda": { n: 6.7, r: 102 },
  "Djibouti": { n: 6.7, r: 101 },
  "Qatar": { n: 6.6, r: 105 },
  "Armenia": { n: 6.6, r: 104 },
  "Brazil": { n: 6.5, r: 106 },
  "Guinea": { n: 6.3, r: 108 },
  "Albania": { n: 6.3, r: 107 },
  "Zambia": { n: 6.1, r: 109 },
  "Senegal": { n: 6, r: 111 },
  "Papua New Guinea": { n: 6, r: 110 },
  "Republic Of The Congo": { n: 5.9, r: 114 },
  "Bangladesh": { n: 5.9, r: 113 },
  "Bahrain": { n: 5.9, r: 112 },
  "Dr Congo": { n: 5.7, r: 115 },
  "Malaysia": { n: 5.5, r: 116 },
  "Tanzania": { n: 5.4, r: 119 },
  "Israel": { n: 5.4, r: 118 },
  "Ghana": { n: 5.4, r: 117 },
  "Cyprus": { n: 5.3, r: 121 },
  "Cambodia": { n: 5.3, r: 120 },
  "Libya": { n: 5.2, r: 122 },
  "Mexico": { n: 5.1, r: 124 },
  "Gambia": { n: 5.1, r: 123 },
  "Greece": { n: 5, r: 126 },
  "Fiji": { n: 5, r: 125 },
  "Peru": { n: 4.9, r: 128 },
  "Mozambique": { n: 4.9, r: 127 },
  "Mali": { n: 4.8, r: 129 },
  "Somalia": { n: 4.7, r: 134 },
  "Solomon Islands": { n: 4.7, r: 133 },
  "Belize": { n: 4.7, r: 132 },
  "Angola": { n: 4.7, r: 131 },
  "Afghanistan": { n: 4.7, r: 130 },
  "Timor Leste": { n: 4.6, r: 137 },
  "Niger": { n: 4.6, r: 136 },
  "Brunei": { n: 4.6, r: 135 },
  "Vanuatu": { n: 4.5, r: 138 },
  "Samoa": { n: 4.4, r: 140 },
  "Mauritania": { n: 4.4, r: 139 },
  "Panama": { n: 4.3, r: 141 },
  "Iran": { n: 4.1, r: 142 },
  "Egypt": { n: 4, r: 144 },
  "Guinea Bissau": { n: 4, r: 143 },
  "Oman": { n: 3.9, r: 146 },
  "Madagascar": { n: 3.9, r: 145 },
  "Venezuela": { n: 3.7, r: 149 },
  "South Sudan": { n: 3.7, r: 148 },
  "Malawi": { n: 3.7, r: 147 },
  "Tonga": { n: 3.5, r: 150 },
  "Tunisia": { n: 3.4, r: 152 },
  "Indonesia": { n: 3.4, r: 151 },
  "Lebanon": { n: 3.3, r: 153 },
  "Saudi Arabia": { n: 3.2, r: 157 },
  "Philippines": { n: 3.2, r: 156 },
  "Kenya": { n: 3.2, r: 155 },
  "Algeria": { n: 3.2, r: 154 },
  "Iraq": { n: 3, r: 158 },
  "Pakistan": { n: 2.9, r: 162 },
  "Morocco": { n: 2.9, r: 161 },
  "Jordan": { n: 2.9, r: 160 },
  "Honduras": { n: 2.9, r: 159 },
  "United Arab Emirates": { n: 2.8, r: 163 },
  "Guatemala": { n: 2.7, r: 164 },
  "Azerbaijan": { n: 2.6, r: 165 },
  "Tajikistan": { n: 2.5, r: 166 },
  "Saint Vincent And The Grenadines": { n: 2.4, r: 167 },
  "Sao Tome And Principe": { n: 2.3, r: 170 },
  "Maldives": { n: 2.3, r: 169 },
  "Kuwait": { n: 2.3, r: 168 },
  "Jamaica": { n: 2.2, r: 171 },
  "Syria": { n: 1.9, r: 172 },
  "Grenada": { n: 1.7, r: 174 },
  "Bahamas": { n: 1.7, r: 173 },
  "Barbados": { n: 0.8, r: 175 },
  "Antigua And Barbuda": { n: 0.5, r: 176 }
};

function setupRotation(svg, projection) {
  var lastRotation = [0, 0, 0];
  var mouseDownPos = false;
  var cometHits = [];

  svg.on("mousemove", function() {
    if (mouseDownPos) {
      var p = d3.mouse(this);
      diffX = (p[0] - mouseDownPos[0]) / 4;
      diffY = (p[1] - mouseDownPos[1]) / 4;
      projection.rotate([lastRotation[0] + diffX, lastRotation[1] - diffY]);
      svg.selectAll("path").attr("d", path);

    svg.selectAll("circle")
      .attr("cx", function (d) { return projection([d.lon, d.lat])[0]; })
      .attr("cy", function (d) { return projection([d.lon, d.lat])[1]; })
      .style("opacity", function (d) {
        // TODO: make opacity 0 (marker invisible) when circle is out of
        // visible area.
        return 0.7;
      });
    }
  });

  svg.on("mousedown", function() {
    mouseDownPos = d3.mouse(this);
    lastRotation = projection.rotate()
  });


  svg.on("dblclick", function() {
    mousePos = d3.mouse(this);
    coords = projection.invert(mousePos);
    cometHits.push({'lon': coords[0], 'lat': coords[1]});

    svg.selectAll("circle")
      .data(cometHits)
      .enter()
      .append("circle")
      .attr("cx", function (d) { return projection([d.lon, d.lat])[0]; })
      .attr("cy", function (d) { return projection([d.lon, d.lat])[1]; })
      .attr("r", 5)
      .style("fill", "blue")
      .style("opacity", 0.7);
  });

  svg.on("mouseup", function() {
    mouseDownPos = false;
  });
}

var width = window.innerWidth;
var height = window.innerHeight;

var projection = d3.geoOrthographic()
  .scale(300)
  .clipAngle(90)
  .translate([width / 2, height / 2]);

var path = d3.geoPath()
  .pointRadius(2)
  .projection(projection);

var svg = d3.select("#world-map")
  .attr("width", width)
  .attr("height", height);

svg.append("defs").append("path")
  .datum({type: "Sphere"})
  .attr("id", "sphere")
  .attr("d", path);
svg.append("use")
  .attr("class", "stroke")
  .attr("xlink:href", "#sphere");

setupRotation(svg, projection);

var g = svg.append("g");

d3.json("countries.json", function(error, topology) {
  g.selectAll()
    .data(topojson.object(topology, topology.objects.countries).geometries)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("data-country", info => {
        return info.properties.name;
      })
      .attr("data-rank", info => {
        if (data[info.properties.name])
          return data[info.properties.name].r;
      })
      .attr("data-number", info => {
        if (data[info.properties.name])
          return data[info.properties.name].n;
      })
      .attr("class", "country")
    console.log("dit");
    document.querySelectorAll("[data-country]").forEach(country => {
      country.addEventListener("mouseover", () => {
        if (!country.getAttribute("data-number")) return;
        document.querySelector("#info").innerHTML = `
          <img class="img" alt="" src="https://tse2.mm.bing.net/th?q=${encodeURIComponent(country.getAttribute("data-country") + " people")}&w=100&h=100&p=0&dpr=2&adlt=moderate&c=1">
          <h1><span class="name">${country.getAttribute("data-country")}</span></h1>
          <p class="n">${country.getAttribute("data-number")} suicides per 100,000</p>
          <p class="r">Rank #${country.getAttribute("data-rank")}</p>
        `;
      });
    });
});
